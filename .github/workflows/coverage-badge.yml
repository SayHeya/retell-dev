name: Coverage Badge

on:
  push:
    branches: [main]

jobs:
  badge:
    name: Update Coverage Badge
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:ci

      - name: Extract coverage percentage
        id: coverage
        run: |
          # Parse coverage from lcov.info file
          LINES_COVERED=$(grep -o "LF:[0-9]*" coverage/lcov.info | awk -F: '{sum+=$2} END {print sum}')
          LINES_HIT=$(grep -o "LH:[0-9]*" coverage/lcov.info | awk -F: '{sum+=$2} END {print sum}')

          # Calculate percentage
          if [ "$LINES_COVERED" -gt 0 ]; then
            COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($LINES_HIT / $LINES_COVERED) * 100}")
          else
            COVERAGE="0"
          fi

          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Create coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: ${{ secrets.GIST_ID }}
          filename: retell-cli-coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.coverage }}%
          valColorRange: ${{ steps.coverage.outputs.coverage }}
          maxColorRange: 100
          minColorRange: 0

      - name: Update README badges
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}

          # Determine color based on coverage
          if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="green"
          elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi

          # Update coverage badge in README
          sed -i "s/coverage-[0-9.]*%25-[a-z]*/coverage-${COVERAGE}%25-${COLOR}/" README.md

          echo "Updated README with coverage: ${COVERAGE}% (${COLOR})"

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: update coverage badge to ${{ steps.coverage.outputs.coverage }}%"
          git push
